import 'dart:async';
import 'dart:io' as io;
import 'package:sembast/sembast.dart';
import 'package:sembast/sembast_io.dart';
import 'package:televerse/telegram.dart';
import 'package:televerse/televerse.dart';
import 'package:shelf/shelf.dart';
import 'package:shelf/shelf_io.dart' as shelf_io;
import 'package:cron/cron.dart';

//–ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ, –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã–µ –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å –±–∞–∑–æ–π –¥–∞–Ω–Ω—ã—Ö sembast
late Database db;
var store = intMapStoreFactory.store();

//cron - —ç—Ç–æ –º–µ—Ö–∞–Ω–∏–∑–º, –ø–æ–∑–≤–æ–ª—è—é—â–∏–π –≤—ã–ø–æ–ª–Ω—è—Ç—å –∫–æ–º–∞–Ω–¥—ã —á–µ—Ä–µ–∑ –∑–∞–¥–∞–Ω–Ω–æ–µ –≤—Ä–µ–º—è
//–ø–æ—Å–ª–µ —Å—Ç–∞—Ä—Ç–∞ –ø—Ä–æ–≥—Ä–∞–º–º—ã
final cron = Cron();

//–≤ –∫–∞–≤—ã—á–∫–∞—Ö –Ω–∞–¥–æ —É–∫–∞–∑–∞—Ç—å —Ç–æ–∫–µ–Ω, –∫–æ—Ç–æ—Ä—ã–π –¥–∞–µ—Ç BotFather
Bot bot = Bot('2490564902756902746:562-495824-98549-28');

//–ø–æ—Ä—Ç, –ø–æ –∫–æ—Ç–æ—Ä–æ–º—É –º–æ–∂–Ω–æ –±—É–¥–µ—Ç –ø–∏–Ω–≥–æ–≤–∞—Ç—å –±–æ—Ç–∞
int watchdogPort=27051;

// –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä –∞–¥–º–∏–Ω–∞ - –µ–≥–æ –º–æ–∂–Ω–æ —É–∑–Ω–∞—Ç—å —Å –ø–æ–º–æ—â—å—é https://t.me/chatIDrobot
int adminId=1234567890;

//–º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Å–æ–æ–±—â–µ–Ω–∏–π –æ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π, –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –∫–æ—Ç–æ—Ä—ã—Ö
//–¥–ª—è –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏ –æ—Ç–≤–µ—Ç–∞ –∞–¥–º–∏–Ω–æ–º –º—ã –ø–ª–∞–Ω–∏—Ä—É–µ–º —Ö—Ä–∞–Ω–∏—Ç—å –≤ –ª–æ–∫–∞–ª—å–Ω–æ–π –ë–î
//
//15 —Ç—ã—Å—è—á –∑–∞–ø–∏—Å–µ–π —Å –ø–ª–∞–Ω–∏—Ä—É–µ–º—ã–º –æ–±—ä–µ–º–æ–º - —ç—Ç–æ –ø—Ä–∏–º–µ—Ä–Ω–æ –º–µ–≥–∞–±–∞–π—Ç
//—Ç–æ—Ä–º–æ–∑–∏—Ç—å sembast –Ω–∞—á–∏–Ω–∞–µ—Ç –≥–¥–µ-—Ç–æ –Ω–∞ 30 –º–µ–≥–∞–±–∞–π—Ç–∞—Ö, —Ç–æ –µ—Å—Ç—å –Ω–∞ 450 —Ç—ã—Å—è—á–∞—Ö –∑–∞–ø–∏—Å–µ–π
//–≠—Ç–∞ —Ü–∏—Ñ—Ä–∞ –∑–∞–≤–∏—Å–∏—Ç –æ—Ç –≤–∞—à–µ–≥–æ –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏—è –∏ —è–≤–ª—è–µ—Ç—Å—è –ø—Ä–∏–º–µ—Ä–Ω–æ–π,
//–ø–æ—ç—Ç–æ–º—É –¥–ª—è –±–æ–ª—å—à–∏—Ö –±–æ—Ç–æ–≤ –ª—É—á—à–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç—å—Å—è –Ω–æ—Ä–º–∞–ª—å–Ω–æ–π –ë–î
//–∞ –ø–æ–∫–∞ –º—ã –ø–ª–∞–Ω–∏—Ä—É–µ–º –ø—Ä–æ—Å—Ç–æ —É–¥–∞–ª—è—Ç—å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –±–æ–ª–µ–µ —Å—Ç–∞—Ä—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏—è—Ö –µ—Å–ª–∏
//–æ–±—â–µ–µ –∏—Ö –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø—Ä–µ–≤—ã—à–∞–µ—Ç —ç—Ç–æ—Ç –ø–æ—Ä–æ–≥
int maxRecordsCount=20000;

//—Å—Ç—Ä–æ–∫–∞, –∫–æ—Ç–æ—Ä—É—é –±—É–¥–µ—Ç –≤–æ–∑–≤—Ä–∞—â–∞—Ç—å –≤—Å—Ç—Ä–æ–µ–Ω–Ω—ã–π –≤–µ–±-—Å–µ—Ä–≤–µ—Ä
String response = '–≤—Å–µ —Ä–∞–±–æ—Ç–∞–µ—Ç –æ—Ç–ª–∏—á–Ω–æ';

//—Å—Å—ã–ª–∫–∏ –¥–ª—è –∫–Ω–æ–ø–æ–∫ - –ø–æ–¥—Å—Ç–∞–≤—å—Ç–µ —Å–≤–æ–µ
String productOneLink ='https://mail.ru';
String productTwoLink ='https://yandex.ru';


String greetingMessage =
    '–ù–∞—à–∞ —Ñ–∏—Ä–º–∞ –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤—É–µ—Ç –í–∞—Å!üëã\n\n –ù–∏–∂–µ —Ä–∞—Å–ø–æ–ª–æ–∂–µ–Ω—ã —Å—Å—ã–ª–∫–∏ –Ω–∞ –Ω–∞—à–∏'
    ' –ª—É—á—à–∏–µ –ø—Ä–æ–¥—É–∫—Ç—ã üëáüëá\n\n';

String askUsPrompt = '–ü–µ—Ä–µ–π–¥–∏—Ç–µ –≤ —á–∞—Ç —Å –∂–∏–≤—ã–º —á–µ–ª–æ–≤–µ–∫–æ–º. –û–Ω –∑–Ω–∞–µ—Ç –≤—Å—ë ü§ì\n'
    'https://t.me/your_manager_account';


//"–ø–æ—Å–ª–µ–¥–Ω–∏–µ" –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–Ω—ã–π —Å–æ–æ–±—â–µ–Ω–∏—è –º—ã –±—É–¥–µ–º —Ö—Ä–∞–Ω–∏—Ç—å –≤ –æ–ø–µ—Ä–∞—Ç–∏–≤–Ω–æ–π –ø–∞–º—è—Ç–∏
//—ç—Ç–æ —á—Ä–µ–≤–∞—Ç–æ –ø—Ä–æ–±–ª–µ–º–∞–º–∏ –ø—Ä–∏ —É—Å–ª–æ–≤–∏–∏ –º–Ω–æ–≥–æ–º–∏–ª–ª–∏–æ–Ω–Ω–æ–π –∞—É–¥–∏—Ç–æ—Ä–∏–∏,
//–Ω–æ –¥–ª—è –º–∞–ª–µ–Ω—å–∫–æ–≥–æ –±–æ—Ç–∞ (–Ω–µ—Å–∫–æ–ª—å–∫–æ —Ç—ã—Å—è—á –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π) —ç—Ç–æ –Ω–µ—Å—É—â–µ—Å—Ç–≤–µ–Ω–Ω–æ
//–∑–∞—Ç–æ –¥–∞–µ—Ç –±–û–ª—å—à—É—é –ø–ª–∞–≤–Ω–æ—Å—Ç—å —Ä–∞–±–æ—Ç—ã
//
//ID - —ç—Ç–æ –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä —á–∞—Ç–∞, —á—Ç–æ–±—ã –Ω–µ —É–¥–∞–ª–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ –Ω–µ —É —Ç–æ–≥–æ —á–µ–ª–æ–≤–µ–∫–∞
Map<ID, Message> lastMsg = {};


//–ú–µ–Ω—é –¥–ª—è –ø–µ—Ä–≤–æ–≥–æ (–ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ–≥–æ) —Å–æ–æ–±—â–µ–Ω–∏—è
final keyboardMenu = InlineMenu()
    .text("–ü—Ä–æ–¥—É–∫—Ç 1 üòã", (ctx) {sendLink(ctx, link: productOneLink);})
    .row()
    .text("–ü—Ä–æ–¥—É–∫—Ç 2 üçé", (ctx) { sendLink(ctx, link: productTwoLink);})
    .row()
    .text("–ó–∞–¥–∞—Ç—å –≤–æ–ø—Ä–æ—Å üñê", askUs);

//–º–µ–Ω—é –¥–ª—è –ø–µ—Ä–µ—Ö–æ–¥–∞ –≤ –Ω–∞—á–∞–ª–æ
final backMenu = InlineMenu().text("–ù–∞–∑–∞–¥", firstMessage);

void main() async {

  dbInit(); //–∏–Ω—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è db sembast
  httpStart(); //—Å—Ç–∞—Ä—Ç –≤–µ–±-—Å–µ—Ä–≤–µ—Ä–∞ –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –∂–∏–≤—É—á–µ—Å—Ç–∏
  botStart(); //–∑–∞–ø—É—Å–∫ –±–æ—Ç–∞

  bot.onText(onText); //–æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –ø–æ—Å—Ç—É–ø–∞—é—â–∏—Ö –æ—Ç —á–µ–ª–æ–≤–µ–∫–∞ —Ç–µ–∫—Å—Ç–æ–≤—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π

  //–æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –Ω–∞ –æ—Å—Ç–∞–ª—å–Ω—ã–µ —Ç–∏–ø—ã —Å–æ–æ–±—â–µ–Ω–∏–π
  bot.onPhoto(errorType);
  bot.onDocument(errorType);
  bot.onVideo(errorType);
  bot.onVoice(errorType);
  bot.onVideoNote(errorType);
}


void dbInit() async {
  //–∑–∞–ø—É—Å–∫ –ª–æ–∫–∞–ª—å–Ω–æ–≥–æ —Ö—Ä–∞–Ω–∏–ª–∏—â–∞ –¥–ª—è –æ–±–µ—Å–ø–µ—á–µ–Ω–∏—è –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏ –æ—Ç–≤–µ—Ç–∞
  //–∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–º –Ω–∞ —Å–æ–æ–±—â–µ–Ω–∏—è.

  DatabaseFactory dbFactory = databaseFactoryIo;

  //–ï—Å–ª–∏ —Ñ–∞–π–ª–∞ –ø–æ —É–∫–∞–∑–∞–Ω–Ω–æ–º—É –ø—É—Ç–∏ –Ω–µ –±—É–¥–µ—Ç - –æ–Ω —Å–æ–∑–¥–∞—Å—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏
  db = await dbFactory.openDatabase('${io.Directory.current.path}/messageIds.db');

  //–ª—É—á—à–µ —Å–µ–π—á–∞—Å, –ø—Ä–∏ —Å—Ç–∞—Ä—Ç–µ –≤—ã–ø–æ–ª–Ω–∏—Ç—å –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏—é —Ñ–∞–π–ª–∞ –ë–î.
  //—ç—Ç–æ —Å–ª–µ–≥–∫–∞ –∑–∞—Ç—è–Ω–µ—Ç –∑–∞–ø—É—Å–∫, –Ω–æ —É–±–µ—Ä–µ–∂–µ—Ç –æ—Ç –ø—Ä–æ–±–ª–µ–º –≤ –±—É–¥—É—â–µ–º
  compactDb(maxRecordsCount);

  //–∫–∞–∂–¥—ã–µ —à–µ—Å—Ç—å —á–∞—Å–æ–≤ –≤—ã–ø–æ–ª–Ω—è–µ–º –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏—é –ë–î
  //–≤ –∏–¥–µ–∞–ª–µ —ç—Ç–æ –Ω–∞–¥–æ –ø—Ä–∏–≤—è–∑–∞—Ç—å –∫ –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–º—É –≤—Ä–µ–º–µ–Ω–∏,
  //—á—Ç–æ–±—ã —ç—Ç–∞ —Ä–∞–±–æ—Ç–∞ –≤—ã–ø–æ–ª–Ω—è–ª–∞—Å—å –ø—Ä–∏ –º–∏–Ω–∏–º–∞–ª—å–Ω–æ–π –∑–∞–≥—Ä—É–∑–∫–µ –±–æ—Ç–∞
  cron.schedule(Schedule.parse('* 6 * * *'), () async {
    compactDb(maxRecordsCount);
  });
}


void httpStart() async {
  //–∑–∞–ø—É—Å–∫ –≤–µ–±-—Å–µ—Ä–≤–µ—Ä–∞ –¥–ª—è –ø–µ—Ä–∏–æ–¥–∏—á–µ—Å–∫–æ–π –ø—Ä–æ–≤–µ—Ä–∫–∏ –∂–∏–∑–Ω–∏ –±–æ—Ç–∞
  //—Ç.–∫. –±–æ—Ç –º–æ–∂–µ—Ç –≤—ã–ª–µ—Ç–∞—Ç—å, –º–æ–∂–µ—Ç –±—ã—Ç—å –Ω–µ–¥–æ—Å—Ç—É–ø–Ω—ã–º —Å–µ—Ä–≤–µ—Ä –∏ —Ç.–ø.
  var handler = const Pipeline().addMiddleware(logRequests()).addHandler(_echoRequest);
  var server = await shelf_io.serve(handler, '0.0.0.0', watchdogPort);
  server.autoCompress = true;
  print('Serving at http://${server.address.host}:${server.port}');
}

botStart() {
  //–ø–µ—Ä–µ–¥ –∑–∞–ø—É—Å–∫–æ–º —Å—Ä–∞–∑—É –∞—Å—Å–æ—Ü–∏–∏—Ä—É–µ–º —Å –±–æ—Ç–æ–º –æ–±–µ –Ω–∞—à–∏ –º–µ–Ω—é—à–∫–∏
  bot.attachMenu(keyboardMenu);
  bot.attachMenu(backMenu);
  print('starting bot');

  try {
    //–±–æ—Ç –∑–∞–ø—É—Å–∫–∞–µ—Ç—Å—è —ç—Ç–æ–π –∫–æ–º–∞–Ω–¥–æ–π, –æ–Ω–∞ –∂–µ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –∫–æ–º–∞–Ω–¥—É /start
    bot.start(firstMessage);
  } on Exception catch (e) {
    response = 'start error $e';
  }
}



void firstMessage(Context ctx) async {
  //–∑–∞–≥–ª–∞–≤–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –±–æ—Ç–∞, –∫–æ—Ç–æ—Ä–æ–µ –º—ã –±—É–¥–µ–º —É–¥–∞–ª—è—Ç—å –ø—Ä–∏ –Ω–∞–∂–∞—Ç–∏–∏
  //–Ω–∞ –æ–¥–Ω—É –∏–∑ –∫–Ω–æ–ø–æ–∫

  //—ç—Ç–∞ –ø—Ä–æ–≤–µ—Ä–∫–∞ –Ω—É–∂–Ω–∞, —á—Ç–æ–±—ã –ø–æ–≤—Ç–æ—Ä–Ω–æ –Ω–µ –æ—Ç–ø—Ä–∞–≤–ª—è—Ç—å –ø–µ—Ä–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ
  //–∏ –¥–æ–ª–∂–Ω–∞ –±—ã—Ç—å –∑–∞–º–µ–Ω–µ–Ω–∞ –¥—Ä—É–≥–æ–π –ª–æ–≥–∏–∫–æ–π, –µ—Å–ª–∏ —É –≤–∞—Å –±–æ–ª–µ–µ —Ä–∞–∑–≤–µ—Ä–Ω—É—Ç–æ–µ –º–µ–Ω—é
  if (lastMsg[ctx.id]==null) {

    //–æ—Ç–ø—Ä–∞–≤–ª—è–µ–º –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω—É—é –∫–∞—Ä—Ç–∏–Ω–∫—É —á–µ—Ä–µ–∑ API
    //ID —á–∞—Ç–∞ –±–µ—Ä–µ–º –∏–∑ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞,
    //–∫–∞—Ä—Ç–∏–Ω–∫–∞ –≤ –±—É–¥—É—â–µ–º –¥–æ–ª–∂–Ω–∞ –ª–µ–∂–∞—Ç—å –≤ —Ç–æ–π –∂–µ –ø–∞–ø–∫–µ, —á—Ç–æ –∏ –±–∏–Ω–∞—Ä–Ω–∏–∫
    var lastMessage = await bot.api.sendPhoto(
      ID.create(ctx.chat!.id),
      InputFile.fromFile(io.File('${io.Directory.current.path}/main_logo.jpg')),
      caption: greetingMessage,
      replyMarkup: keyboardMenu,
    );

    //–∞ —ç—Ç–æ –º—ã –∑–∞–ø–æ–º–∏–Ω–∞–µ–º, —á—Ç–æ –≤ —á–∞—Ç–µ —Å —ç—Ç–∏–º —á–µ–ª–æ–≤–µ–∫–æ–º –ø–æ—Å–ª–µ–¥–Ω–µ–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–Ω–æ–µ
    //—Å–æ–æ–±—â–µ–Ω–∏–µ - –Ω–∞—à–µ –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ–µ
    lastMsg.addAll({ctx.id: lastMessage});
  }
}

removeLastMessage(Context ctx) {
  //—É–¥–∞–ª—è–µ–º –ø–æ—Å–ª–µ–¥–Ω–µ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –∏–∑ —á–∞—Ç–∞
  //–º–µ—Ö–∞–Ω–∏–∑–º –Ω—É–∂–µ–Ω –¥–ª—è —Ç–æ–≥–æ, —á—Ç–æ–±—ã –ø—Ä–∏ –Ω–∞–∂–∞—Ç–∏–∏ –Ω–∞ –∫–Ω–æ–ø–∫—É –ø–æ–¥ —Å–æ–æ–±—â–µ–Ω–∏–µ–º
  //—É –Ω–∞—Å —Å–æ–∑–¥–∞–≤–∞–ª—Å—è —ç—Ñ—Ñ–µ–∫—Ç –ø–µ—Ä–µ—Ö–æ–¥–∞ –Ω–∞ —Å–ª–µ–¥—É—é—â–∏–π —ç–∫—Ä–∞–Ω

  if (ctx.chat != null) {
    ID chatId = ID.create(ctx.chat!.id);
    if (lastMsg[chatId] != null) {
      int messageId = lastMsg[chatId]!.messageId;
      try {
        bot.api.deleteMessage(chatId, messageId);
        lastMsg.remove(chatId);
      } on Exception catch (e) {
        print ('error while removeLastMessage: $e');
     }
    }
  }
}



FutureOr<void> sendLink(Context ctx, {required String link}) {
  //—Ä–µ–∞–∫—Ü–∏—è –Ω–∞ –Ω–∞–∂–∞—Ç–∏–µ –∫–Ω–æ–ø–∫–∏ —Å –æ—Ç–ø—Ä–∞–≤–∫–æ–π —Å—Å—ã–ª–∫–∏:
  //—É–¥–∞–ª—è–µ–º –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –∏ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —Å—Å—ã–ª–∫—É —Å –∫–Ω–æ–ø–∫–æ–π "–Ω–∞–∑–∞–¥"
  removeLastMessage(ctx);
  ctx.reply(link, replyMarkup: backMenu);
}


FutureOr<void> askUs(Context ctx) {
  //—Ä–µ–∞–∫—Ü–∏—è –Ω–∞ –Ω–∞–∂–∞—Ç–∏–µ –∫–Ω–æ–ø–∫–∏ "–ó–∞–¥–∞—Ç—å –≤–æ–ø—Ä–æ—Å"
  ctx.reply(askUsPrompt);
}

Future<void> onText(Context ctx) async {
  //—Ä–µ–∞–∫—Ü–∏—è –Ω–∞ –ø–æ–ª—É—á–µ–Ω–Ω–æ–µ —Ç–µ–∫—Å—Ç–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ
  //–æ—Å–Ω–æ–≤–Ω–∞—è –∑–∞–¥–∞—á–∞ - –µ—Å–ª–∏ —ç—Ç–æ —Å–æ–æ–±—â–µ–Ω–∏–µ –Ω–µ –æ—Ç –∞–¥–º–∏–Ω–∞, —Ç–æ –ø–µ—Ä–µ—Å—ã–ª–∞–µ–º –µ–≥–æ –∞–¥–º–∏–Ω—É
  //–≤ —Å–∞–º–æ–º –±–æ—Ç–µ.
  //
  //–µ—Å–ª–∏ –∞–¥–º–∏–Ω —Ä–µ—à–∞–µ—Ç –æ—Ç–≤–µ—Ç–∏—Ç—å –Ω–∞ –ª—é–±–æ–µ –∏–∑ —Å–æ–æ–±—â–µ–Ω–∏–π –∏–∑ –±–æ—Ç–∞ - —Ç–æ –µ–≥–æ –æ—Ç–≤–µ—Ç
  //—É—Ö–æ–¥–∏—Ç –≤ —á–µ—Ä–µ–∑ –±–æ—Ç–∞ —Ç–æ–ª—å–∫–æ –Ω—É–∂–Ω–æ–º—É —á–µ–ª–æ–≤–µ–∫—É
  //
  //—Ç.–∫. –Ω–∞ –¥–∞–Ω–Ω—ã–π –º–æ–º–µ–Ω—Ç –Ω–µ–ª—å–∑—è —ç—Ç–æ —Ä–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏, –º—ã
  //–≤—ã–Ω—É–∂–¥–µ–Ω—ã —Å–æ—Ö—Ä–∞–Ω—è—Ç—å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ–±–æ –≤—Å–µ—Ö –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–Ω—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏—è—Ö –≤ –ª–æ–∫–∞–ª—å–Ω–æ–π –ë–î
  //
  //–ø—Ä–∏ —ç—Ç–æ–º –∫–æ–≥–¥–∞ –º—ã –ø–æ—Å—ã–ª–∞–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –∞–¥–º–∏–Ω—É, –º—ã –≤ –ø–µ—Ä–≤–æ–π —Å—Ç—Ä–æ–∫–µ –ø–∏—à–µ–º –∏–º—è
  //–æ—Ç–ø—Ä–∞–≤–∏—Ç–µ–ª—è –∏ –Ω–æ–º–µ—Ä —Å–æ–æ–±—â–µ–Ω–∏—è, –ø–æ –∫–æ—Ç–æ—Ä–æ–º—É –ø–æ—Ç–æ–º –Ω–∞–π–¥–µ–º ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
  //
  //–í —Å–ª—É—á–∞–µ, –µ—Å–ª–∏ –º—ã –≤–º–µ—Å—Ç–æ –Ω–æ–º–µ—Ä–∞ —Å–æ–æ–±—â–µ–Ω–∏—è –±—É–¥–µ–º –æ—Ç–ø—Ä–∞–≤–ª—è—Ç—å —Å—Ä–∞–∑—É ID –æ—Ç–ø—Ä–∞–≤–∏—Ç–µ–ª—è,
  //—Ç–æ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç—å –≤ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–∏ –ª–æ–∫–∞–ª—å–Ω–æ–π –ë–î –æ—Ç–ø–∞–¥–∞–µ—Ç, –Ω–æ —Ç–æ–≥–¥–∞ –≤–∞—à –∞–¥–º–∏–Ω
  //–ø–æ–ª—É—á–∞–µ—Ç –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å –ø–∏—Å–∞—Ç—å –≤–∞—à–∏–º –∫–ª–∏–µ–Ω—Ç–∞–º –≤ –ª–∏—á–∫—É –≤ –æ–±—Ö–æ–¥ –±–æ—Ç–∞


  //–ï—Å–ª–∏ –ø–æ–ª—É—á–µ–Ω–Ω–æ–µ —Ç–µ–∫—Å—Ç–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ - —ç—Ç–æ –æ—Ç–≤–µ—Ç –∞–¥–º–∏–Ω–∞ –∫–ª–∏–µ–Ω—Ç—É, —Ç–æ....
  if (ctx.id==ID.create(adminId) &&
      ctx.message!=null && ctx.message!.replyToMessage!=null ) {

    //...–≤—ã—Ä–µ–∑–∞–µ–º –∏–∑ —Å–æ–æ–±—â–µ–Ω–∏—è –Ω–æ–º–µ—Ä, –∑–∞–∫–ª—é—á–µ–Ω–Ω—ã–π –º–µ–∂–¥—É #
    String messageText=ctx.message!.replyToMessage!.text??'' ;
    int messageId=0;
    int startIndex = messageText.indexOf('#');
    int endIndex = messageText.indexOf('#', startIndex + 1);
    if (startIndex != -1 && endIndex != -1) {
      messageId = int.tryParse(messageText.substring(startIndex + 1, endIndex))??0;
    }

    //...–∑–∞—Ç–µ–º –ø—ã—Ç–∞–µ–º—Å—è –Ω–∞–π—Ç–∏ —Ç–∞–∫—É—é –∑–∞–ø–∏—Å—å –≤ –ª–æ–∫–∞–ª—å–Ω–æ–π –ë–î, –∏ –µ—Å–ª–∏ –æ–Ω–∞ –µ—Å—Ç—å -
    //–¥–æ—Å—Ç–∞–µ–º –æ—Ç—Ç—É–¥–∞ ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏ –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º –µ–º—É —Ç–µ–∫—Å—Ç –æ—Ç –∞–¥–º–∏–Ω–∞ –≤ –±–æ—Ç–µ


    var user = await store.record(messageId).get(db);
    if (user!=null) {
      int userId = int.tryParse(user['userId'].toString()) ?? adminId;
      bot.api.sendMessage(
          ID.create(userId),
          ctx.message!.text ?? ''
      );
    }
  }
  //–∏–Ω–∞—á–µ, –µ—Å–ª–∏ —ç—Ç–æ —Å–æ–æ–±—â–µ–Ω–∏–µ –æ—Ç –æ–±—ã—á–Ω–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è,
  //–º—ã —Å–æ—Ö—Ä–∞–Ω—è–µ–º —Å–ª—É–∂–µ–±–Ω—É—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –≤ –ª–æ–∫–∞–ª—å–Ω—É—é –ë–î –∏ –ø–µ—Ä–µ—Å—ã–ª–∞–µ–º —Ç–µ–∫—Å—Ç –∞–¥–º–∏–Ω—É
  else {
    if (ctx.from != null && ctx.message!=null){
        await store.record(ctx.message!.messageId).put(
            db,
            {'userId': ctx.from!.id, 'userName': ctx.from!.username ?? 'anon'}
        );

   }
    bot.api.sendMessage(
        ID.create(adminId),
       '–û—Ç: ${ctx.message!.from!.firstName}, #${ctx.message!.messageId}#\n  ${ctx.message!.text ?? ''}'
    );
  }
}

Future<void> errorType(Context ctx) async {
  //—Ä—É–≥–∞–µ–º—Å—è, –µ—Å–ª–∏ –Ω–∞–º –ø—Ä–∏—Å–ª–∞–ª–∏ –≤–æ–π—Å –∏–ª–∏ –∫–∞—Ä—Ç–∏–Ω–∫—É –∏–ª–∏ –µ—â–µ —á–µ–≥–æ-–Ω–∏–±—É–¥—å
  ctx.reply('–ò–∑–≤–∏–Ω–∏—Ç–µ, —Ä–∞–∑—Ä–µ—à–µ–Ω–æ –ø–æ—Å—ã–ª–∞—Ç—å —Ç–æ–ª—å–∫–æ —Ç–µ–∫—Å—Ç');
}

compactDb(int maxRecords) async {
  //–æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è —Ñ–∞–π–ª–∞ –ª–æ–∫–∞–ª—å–Ω–æ–π –ë–î –ø–æ –¥–æ—Å—Ç–∏–∂–µ–Ω–∏–∏ —É–∫–∞–∑–∞–Ω–Ω–æ–≥–æ –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ –∑–∞–ø–∏—Å–µ–π
  //–ø—Ä–∏ —ç—Ç–æ–º —É–¥–∞–ª—è—é—Ç—Å—è –ø–µ—Ä–≤—ã–µ –∑–∞–ø–∏—Å–∏, –æ—Å—Ç–∞–≤–ª—è—è –≤ –ë–î maxRecords –∑–∞–ø–∏—Å–µ–π
  //—Å–∫–æ—Ä–æ—Å—Ç—å —Ä–∞–±–æ—Ç—ã –∑–∞–≤–∏—Å–∏—Ç –æ—Ç –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ –∑–∞–ø–∏—Å–µ–π –≤—ã—à–µ maxRecords
  int recordCounts = await store.count(db);

  if (recordCounts >maxRecords) {
    store.delete(db,finder: Finder(sortOrders: [SortOrder('key')], limit: recordCounts-maxRecords));
    db.compact();
  }
}

//—ç—Ç–æ –æ—Ç–≤–µ—Ç –Ω–∞—à–µ–≥–æ –≤—Å—Ç—Ä–æ–µ–Ω–Ω–æ–≥–æ –≤–µ–±-—Å–µ—Ä–≤–µ—Ä–∞ –¥–ª—è –Ω–∞–±–ª—é–¥–µ–Ω–∏—è –∑–∞ –±–æ—Ç–æ–º
//–ø–æ—Å–∫–æ–ª—å–∫—É –ø–µ—Ä–∏–æ–¥–∏—á–Ω–æ—Å—Ç—å –∑–∞–ø—Ä–æ—Å–æ–≤ —Å–æ —Å—Ç–æ—Ä–æ–Ω—ã –º—ã –Ω–µ –∑–Ω–∞–µ–º, —Ç–æ –ø–µ—Ä–µ–º–µ–Ω–Ω—É—é
//response –∏–º–µ–µ—Ç —Å–º—ã—Å–ª —Å–¥–µ–ª–∞—Ç—å –≥–ª–æ–±–∞–ª—å–Ω–æ–π –∏ –º–µ–Ω—è—Ç—å –µ–µ –Ω–∞ –Ω—É–∂–Ω—ã–µ –Ω–∞–º
//–∑–Ω–∞—á–µ–Ω–∏—è –∫–∞–∂–¥—ã–π —Ä–∞–∑, –∫–æ–≥–¥–∞ –º–µ–Ω—è–µ—Ç—Å—è —Å–æ—Å—Ç–æ—è–Ω–∏–µ –±–æ—Ç–∞
Response _echoRequest(Request request) =>
    Response.ok('$response "${request.url}"');